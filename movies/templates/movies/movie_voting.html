{% extends "movies/base.html" %}
{% block title %}Movie Voting{% endblock %}

{% block content %}
<h1 class="mb-4 text-center">ğŸ¬ Community Voting</h1>

{% if movies %}
<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
  {% for movie in movies %}
    <div class="col">
      <div class="card h-100 movie-card">
        {% if movie.poster_url %}
          <img src="{{ movie.poster_url }}"
               class="card-img-top mx-auto d-block"
               alt="{{ movie.title }}">
        {% endif %}

        <div class="card-body d-flex flex-column align-items-center text-center">
          <h5 class="card-title">{{ movie.title }}</h5>
          <p class="card-text">{{ movie.release_date }}</p>

            <div class="d-flex gap-2 justify-content-center">
              {% if user.is_authenticated %}
                {# â”€â”€ AUTHENTICATED: normal like / dislike forms â”€â”€ #}
                <form method="post" action="{% url 'movies:movie_vote' movie.id %}" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="like">
                  <input type="hidden" name="toggle" value="1">
                  <button class="btn btn-sm
                         {% if movie.my_vote == 1 %}btn-success{% else %}btn-outline-success{% endif %}">
                    ğŸ‘ {{ movie.likes }}
                  </button>
                </form>

                <form method="post" action="{% url 'movies:movie_vote' movie.id %}" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="dislike">
                  <input type="hidden" name="toggle" value="1">
                  <button class="btn btn-sm
                         {% if movie.my_vote == -1 %}btn-danger{% else %}btn-outline-danger{% endif %}">
                    ğŸ‘ {{ movie.dislikes }}
                  </button>
                </form>
              {% else %}
                {# â”€â”€ GUEST: buttons trigger login modal â”€â”€ #}
                <button type="button" class="btn btn-sm btn-outline-success need-login">
                  ğŸ‘ {{ movie.likes }}
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger need-login">
                  ğŸ‘ {{ movie.dislikes }}
                </button>
              {% endif %}
            </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>
{% else %}
  <p class="text-center">
    No movies found. Try adding some on the
    <a href="{% url 'movies:search_movie' %}">Search Page</a>.
  </p>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if not user.is_authenticated %}
  <!-- Login Required Modal -->
  <div class="modal fade" id="loginNeededModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-danger">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Login Required</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          You must be <strong>logged in</strong> to vote.<br><br>
          <a class="btn btn-danger" href="{% url 'movies:login' %}">Log in now</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // open modal when any .need-login button is clicked
    document.querySelectorAll(".need-login").forEach(btn => {
      btn.addEventListener("click", () => {
        new bootstrap.Modal(document.getElementById("loginNeededModal")).show();
      });
    });
  </script>
{% endif %}
{% endblock %}
